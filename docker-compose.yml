# Docker Compose конфигурация для инфраструктуры нагрузочного тестирования k6

services:
  # === ПРОМЕТЕЙ - СИСТЕМА СБОРА И ХРАНЕНИЯ МЕТРИК ===
  prometheus:
    # Образ Prometheus версии 2.47.0 для стабильности
    image: prom/prometheus:v2.47.0
    # Проброс порта 9090 на хост для доступа к веб-интерфейсу
    ports: ["9090:9090"]
    volumes:
      # Монтирование конфигурационного файла Prometheus
      - ./prometheus/prometheus.yml:/etc/prometheus/prometheus.yml
      # Том для хранения данных Prometheus (метрики, индексы)
      - prometheus_data:/prometheus
    command:
      # Путь к конфигурационному файлу
      - '--config.file=/etc/prometheus/prometheus.yml'
      # Включение HTTP API для перезагрузки конфигурации без перезапуска
      - '--web.enable-lifecycle'

  # === GRAFANA - СИСТЕМА ВИЗУАЛИЗАЦИИ МЕТРИК ===
  grafana:
    # Образ Grafana версии 10.2.0
    image: grafana/grafana:10.2.0
    # Проброс порта 3001 на хост (стандартный 3000 уже занят у меня)
    ports: ["3001:3000"]
    environment:
      # Пароль администратора (по умолчанию admin/admin)
      - GF_SECURITY_ADMIN_PASSWORD=admin
      # Включение публичных дашбордов для общего доступа
      - GF_FEATURE_TOGGLES_ENABLE=publicDashboards
    volumes:
      # Монтирование конфигурации provisioning (источники данных, дашборды)
      - ./grafana/provisioning:/etc/grafana/provisioning
      # Том для хранения данных Grafana (дашборды, пользователи)
      - grafana_data:/var/lib/grafana
    depends_on:
      # Grafana зависит от Prometheus и InfluxDB для источников данных
      - prometheus
      - influxdb

  # === NODE EXPORTER - СБОРА МЕТРИК СИСТЕМЫ ===
  node-exporter:
    # Образ Node Exporter для сбора системных метрик
    image: prom/node-exporter:v1.6.1
    # Проброс порта 9100 для доступа к метрикам
    ports: ["9100:9100"]
    volumes:
      # Монтирование системных директорий для чтения метрик
      - /proc:/host/proc:ro        # Информация о процессах (read-only)
      - /sys:/host/sys:ro          # Системная информация (read-only)
      - /:/rootfs:ro               # Корневая файловая система (read-only)

  # === ALERTMANAGER - СИСТЕМА УПРАВЛЕНИЯ АЛЕРТАМИ ===
  # Закомментировано - алерты пока не требуются, но инфраструктура готова
  # TODO: алерты в prometheus.yml не добавлены - пока нет необходимости возможно когда нибудь
  #  alertmanager:
  #    image: prom/alertmanager:v0.26.0
  #    ports: ["9093:9093"]
  #    volumes:
  #      - ./alertmanager/alertmanager.yml:/etc/alertmanager/alertmanager.yml
  #    command:
  #      - '--config.file=/etc/alertmanager/alertmanager.yml'
  #      - '--storage.path=/alertmanager'

  # === INFLUXDB - БАЗА ДАННЫХ ДЛЯ МЕТРИК K6 ===
  # InfluxDB -> k6 -> со своим подходом чёт лагает по временным меткам (TODO: разобраться если поможет выпилить нах)
  # вместо экспериментального Prometheus remote write - по времени всё ещё не ок
  # P.S. зайти в доку и написать отзыв "какого х..я?!"
  influxdb:
    # Образ InfluxDB версии 1.8 (стабильная LTS версия)
    image: influxdb:1.8
    # Проброс порта 8086 для HTTP API
    ports: ["8086:8086"]
    environment:
      # Автоматическое создание базы данных k6 при старте
      - INFLUXDB_DB=k6
      # Отключение аутентификации для упрощения (в продакшене включить!)
      - INFLUXDB_HTTP_AUTH_ENABLED=false
    volumes:
      # Том для хранения данных InfluxDB
      - influxdb_data:/var/lib/influxdb

  # === K6 DASHBOARD - ОСНОВНОЙ КОНТЕЙНЕР ДЛЯ ЗАПУСКА ТЕСТОВ ===
  k6-dashboard:
    # Официальный образ k6 от Grafana с оптимизацией
    image: grafana/k6:latest
    # Проброс порта 6565 для веб-интерфейса k6
    ports: ["6565:6565"]
    environment:
      # Настройка вывода метрик в InfluxDB по умолчанию
      - K6_OUT=influxdb=http://influxdb:8086/k6
      # Оптимизация производительности k6
      - K6_NO_USAGE_REPORT=true  # Отключаем отправку статистики использования
    volumes:
      # Монтирование директории с тестами в контейнер
      - ./tests:/scripts:ro  # Read-only для безопасности
      # Монтирование директории для результатов
      - ./results:/results
      # Монтирование кеша для ускорения повторных запусков
      - k6_cache:/k6-cache
    # Команда для бесконечного ожидания (контейнер будет жить для выполнения команд)
    entrypoint: ["/bin/sh", "-c", "sleep infinity"]
    # Оптимизация ресурсов
    deploy:
      resources:
        limits:
          memory: 2G
          cpus: '1.0'
        reservations:
          memory: 512M
          cpus: '0.5'
    restart: unless-stopped
    # Health check для k6 контейнера
    healthcheck:
      test: ["CMD", "pgrep", "-f", "sleep infinity"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 5s

  # === REDIS - КЕШИРОВАНИЕ И УПРАВЛЕНИЕ СОСТОЯНИЕМ ===
  redis:
    # Легковесный образ Redis на Alpine Linux
    image: redis:alpine
    # Проброс порта 6379 (стандартный порт Redis)
    ports: ["6379:6379"]
    volumes:
      # Том для хранения данных Redis
      - redis_data:/data

# === ДОКЕР ТОМА - ПЕРСИСТЕНТНОЕ ХРАНЕНИЕ ДАННЫХ ===
volumes:
  # Том для данных Prometheus (метрики, индексы)
  prometheus_data:
  # Том для данных Grafana (дашборды, настройки)
  grafana_data:
  # Том для данных InfluxDB (метрики k6)
  influxdb_data:
  # Том для данных Redis (кеш, состояние)
  redis_data:
  # Том для кеша k6 (ускорение повторных запусков тестов - в процесее)
  k6_cache:
