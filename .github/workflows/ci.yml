# GitHub Actions CI/CD пайплайн для автоматизации нагрузочного тестирования k6
# Этот файл определяет этапы сборки, тестирования и развертывания проекта

name: K6 Load Testing CI/CD

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

env:
  K6_VERSION: "0.45.0"
  # Настройки кеширования
  DOCKER_BUILDKIT: 1
  BUILDKIT_PROGRESS: plain
  # Параллельное выполнение тестов
  PARALLEL_JOBS: 3

jobs:
  # === ВАЛИДАЦИЯ КОНФИГУРАЦИИ ===
  validate_config:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install dependencies
        run: |
          npm install -g ajv-cli

      - name: Validate configuration
        run: |
          node config/validation.js
          echo "Конфигурация валидна"

  # === SMOKE ТЕСТЫ  ===
  smoke_test:
    runs-on: ubuntu-latest
    needs: start_infrastructure
    steps:
      - uses: actions/checkout@v4

      - name: Create results directory
        run: mkdir -p results

      - name: Run smoke tests
        uses: grafana/k6-action@v0.3.0
        with:
          filename: tests/scenarios/smoke-test.js
          flags: "--out json=results/smoke-${{ github.sha }}.json"

      - name: Upload test results
        uses: actions/upload-artifact@v4
        with:
          name: smoke-test-results
          path: results/smoke-${{ github.sha }}.json
          retention-days: 7

  # === LOAD ТЕСТЫ  ===
  load_test:
    runs-on: ubuntu-latest
    needs: smoke_test
    if: github.ref == 'refs/heads/main'
    steps:
      - uses: actions/checkout@v4

      - name: Setup Git
        run: |
          git config --global --add safe.directory $GITHUB_WORKSPACE
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      - name: Create results directory
        run: mkdir -p results

      - name: Run load tests
        uses: grafana/k6-action@v0.3.0
        with:
          filename: tests/scenarios/load-test.js
          flags: '--out json=results/load-${{ github.sha }}.json'
        timeout-minutes: 20

      - name: Upload test results
        uses: actions/upload-artifact@v4
        with:
          name: load-test-results
          path: results/load-${{ github.sha }}.json
          retention-days: 7

  # === STRESS ТЕСТЫ  ===
  stress_test:
    runs-on: ubuntu-latest
    needs: load_test
    if: github.ref == 'refs/heads/main'
    steps:
      - uses: actions/checkout@v4

      - name: Setup Git
        run: |
          git config --global --add safe.directory $GITHUB_WORKSPACE
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      - name: Create results directory
        run: mkdir -p results

      - name: Run stress tests
        uses: grafana/k6-action@v0.3.0
        with:
          filename: tests/scenarios/stress-test.js
          flags: '--out json=results/stress-${{ github.sha }}.json'
        timeout-minutes: 15
        continue-on-error: true

      - name: Upload test results
        uses: actions/upload-artifact@v4
        with:
          name: stress-test-results
          path: results/stress-${{ github.sha }}.json
          retention-days: 7

  # === VOLUME ТЕСТЫ  ===
  volume_test:
    runs-on: ubuntu-latest
    needs: stress_test
    if: github.ref == 'refs/heads/main' && needs.stress_test.result != 'failure'
    steps:
      - uses: actions/checkout@v4

      - name: Setup Git
        run: |
          git config --global --add safe.directory $GITHUB_WORKSPACE
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      - name: Create results directory
        run: mkdir -p results

      - name: Run volume tests
        uses: grafana/k6-action@v0.3.0
        with:
          filename: tests/scenarios/volume-test.js
          flags: '--out json=results/volume-${{ github.sha }}.json'
        timeout-minutes: 40
        continue-on-error: true

      - name: Upload test results
        uses: actions/upload-artifact@v4
        with:
          name: volume-test-results
          path: results/volume-${{ github.sha }}.json
          retention-days: 7

  # === SOAK ТЕСТЫ  === (Закомментированы для ускорения CI/CD)
  # soak_test:
  #   runs-on: ubuntu-latest
  #   needs: start_infrastructure
  #   if: github.ref == 'refs/heads/main'
  #   steps:
  #   - uses: actions/checkout@v4

  #   - name: Setup Git
  #     run: |
  #       git config --global --add safe.directory $GITHUB_WORKSPACE
  #       git config --global user.name "github-actions[bot]"
  #       git config --global user.email "github-actions[bot]@users.noreply.github.com"

  #   - name: Create results directory
  #     run: mkdir -p results

  #   - name: Run soak tests
  #     uses: grafana/k6-action@v0.3.0
  #     with:
  #       filename: tests/scenarios/soak-test.js
  #       flags: '--out json=results/soak-${{ github.sha }}.json'
  #     timeout-minutes: 130

  #   - name: Upload test results
  #     uses: actions/upload-artifact@v4
  #     with:
  #       name: soak-test-results
  #       path: results/soak-${{ github.sha }}.json
  #       retention-days: 7

  # === SECURITY ТЕСТЫ  ===
  security_test:
    runs-on: ubuntu-latest
    needs: start_infrastructure
    if: github.ref == 'refs/heads/main'
    steps:
      - uses: actions/checkout@v4

      - name: Create results directory
        run: mkdir -p results

      - name: Run security tests
        uses: grafana/k6-action@v0.3.0
        with:
          filename: tests/scenarios/security-load-test.js
          flags: '--out json=results/security-${{ github.sha }}.json'

      - name: Upload test results
        uses: actions/upload-artifact@v4
        with:
          name: security-test-results
          path: results/security-${{ github.sha }}.json
          retention-days: 7

  # === ADAPTIVE ТЕСТЫ  ===
  adaptive_test:
    runs-on: ubuntu-latest
    needs: start_infrastructure
    if: github.ref == 'refs/heads/main'
    steps:
      - uses: actions/checkout@v4

      - name: Create results directory
        run: mkdir -p results

      - name: Run adaptive tests
        uses: grafana/k6-action@v0.3.0
        with:
          filename: tests/scenarios/adaptive-load-test.js
          flags: '--out json=results/adaptive-${{ github.sha }}.json'

      - name: Upload test results
        uses: actions/upload-artifact@v4
        with:
          name: adaptive-test-results
          path: results/adaptive-${{ github.sha }}.json
          retention-days: 7

  # === ЗАПУСК ИНФРАСТРУКТУРЫ ===
  start_infrastructure:
    runs-on: ubuntu-latest
    needs: validate_config
    outputs:
      infrastructure-started: true
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install dependencies
        run: npm install

      - name: Setup Docker
        run: |
          docker --version
          docker compose version

      - name: Start infrastructure
        run: docker compose up -d

      - name: Wait for services
        run: sleep 30

      - name: Check services health
        run: chmod +x check-services.sh && npm run check

  # === ОСТАНОВКА ИНФРАСТРУКТУРЫ ===
  stop_infrastructure:
    runs-on: ubuntu-latest
    needs: [ smoke_test, load_test, stress_test, volume_test, security_test, adaptive_test ]
    if: always()
    steps:
      - uses: actions/checkout@v4

      - name: Stop infrastructure
        run: docker compose down

  # === ГЕНЕРАЦИЯ ОТЧЕТОВ ===
  generate_report:
    runs-on: ubuntu-latest
    needs: [ smoke_test, load_test, stress_test, volume_test, security_test, adaptive_test ]
    if: always() && github.ref == 'refs/heads/main'
    steps:
      - name: Authenticate GitHub CLI
        run: echo "GH_TOKEN=${{ github.token }}" >> $GITHUB_ENV
      - uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: Install dependencies
        run: |
          pip install pandas matplotlib plotly

      - name: Download all test results
        uses: actions/download-artifact@v4
        with:
          pattern: '*test-results'
          path: results/
          merge-multiple: true

      - name: List downloaded files
        run: |
          echo "=== Downloaded files in results/ ==="
          ls -la results/
          echo "=== All JSON files ==="
          find results/ -name "*.json" -type f | head -20 || echo "No JSON files found"
          echo "=== Directory structure ==="
          find results/ -type f | head -20 || echo "No files found"

      - name: Check downloaded artifacts
        run: |
          echo "Checking downloaded artifacts..."
          ls -la results/
          find results/ -name "*.json" | head -20
          du -sh results/* 2>/dev/null || echo "No artifacts found"

      - name: Generate HTML reports
        run: |
          mkdir -p results
          find results/ -name "*.json" -exec cp {} results/ \; 2>/dev/null || true

          json_files=$(find results/ -maxdepth 1 -name "*.json" | wc -l)
          echo "Found $json_files JSON files in results directory"

          if [ "$json_files" -gt 0 ]; then
            echo "Found test results, generating HTML reports..."

            # Copy the generate-html-report.py script to the workspace
            cp scripts/generate-html-report.py results/

            # Generate comprehensive HTML report
            cd results && python generate-html-report.py .

            echo "=== Generated HTML files ==="
            find . -name "*.html" | head -10

          else
            echo "No test results found"
          fi

      - name: Upload reports
        uses: actions/upload-artifact@v4
        with:
          name: test-reports
          path: results/
          retention-days: 30

      - name: Upload HTML report separately
        uses: actions/upload-artifact@v4
        with:
          name: html-report
          path: results/k6-load-test-report.html
          retention-days: 30

  # === РАЗВЕРТЫВАНИЕ ИНФРАСТРУКТУРЫ МОНИТОРИНГА === (Закомментировано - требуется регистрация в Docker Hub)
  # deploy_monitoring:
  #   runs-on: ubuntu-latest
  #   needs: generate_report
  #   if: github.ref == 'refs/heads/main'
  #   steps:
  #   - name: Checkout code
  #     uses: actions/checkout@v4

  #   - name: Login to Docker Hub
  #     uses: docker/login-action@v3
  #     with:
  #       username: ${{ secrets.DOCKER_USERNAME }}
  #       password: ${{ secrets.DOCKER_PASSWORD }}

  #   - name: Build and push monitoring image
  #     uses: docker/build-push-action@v5
  #     with:
  #       context: .
  #       file: docker/monitoring.Dockerfile
  #       push: true
  #       tags: ${{ secrets.DOCKER_USERNAME }}/k6-monitoring:latest

  # === УВЕДОМЛЕНИЯ  ===
  notify_slack:
    runs-on: ubuntu-latest
    needs: [ smoke_test, load_test, stress_test, volume_test, security_test, adaptive_test, generate_report ]
    if: always() && github.ref == 'refs/heads/main'
    steps:
      - name: Send Slack notification
        uses: 8398a7/action-slack@v3
        with:
          status: ${{ job.status }}
          text: |
            ${{ job.status == 'success' && 'Yepp)) Load tests passed successfully' || 'Fuck... Load tests failed' }}
            Repository: ${{ github.repository }}
            Branch: ${{ github.ref }}
            Commit: ${{ github.sha }}
            Run: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        if: env.SLACK_WEBHOOK_URL != ''

  # ==== ОЧИСТКА СТАРЫХ АРТЕФАКТОВ ===
  cleanup:
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    steps:
      - name: Clean up old artifacts
        run: |
          echo "Cleaning up old artifacts..."
          # GitHub Actions automatically cleans up old artifacts
          echo "Cleanup completed"