# GitHub Actions CI/CD –ø–∞–π–ø–ª–∞–π–Ω –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏–∏ –Ω–∞–≥—Ä—É–∑–æ—á–Ω–æ–≥–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è k6
# –≠—Ç–æ—Ç —Ñ–∞–π–ª –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç —ç—Ç–∞–ø—ã —Å–±–æ—Ä–∫–∏, —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∏ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—è –ø—Ä–æ–µ–∫—Ç–∞

name: K6 Load Testing CI/CD

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

env:
  K6_VERSION: "0.45.0"
  # –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏—è
  DOCKER_BUILDKIT: 1
  BUILDKIT_PROGRESS: plain
  # –ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ —Ç–µ—Å—Ç–æ–≤
  PARALLEL_JOBS: 3

jobs:
  # === –í–ê–õ–ò–î–ê–¶–ò–Ø –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–ò ===
  validate_config:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "18"

      - name: Install dependencies
        run: |
          npm install -g ajv-cli

      - name: Validate configuration
        run: |
          node config/validation.js
          echo "–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –≤–∞–ª–∏–¥–Ω–∞"

  # === –ó–ê–ü–£–°–ö –ò–ù–§–†–ê–°–¢–†–£–ö–¢–£–†–´ ===
  start_infrastructure:
    runs-on: ubuntu-latest
    needs: validate_config
    outputs:
      infrastructure-started: true
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "18"

      - name: Install dependencies
        run: npm install

      - name: Setup Docker
        run: |
          docker --version
          docker compose version

      - name: Start infrastructure
        run: docker compose up -d

      - name: Wait for services
        run: sleep 30

      - name: Check services health
        run: chmod +x check-services.sh && npm run check

  # === SMOKE –¢–ï–°–¢–´ ===
  smoke_test:
    runs-on: ubuntu-latest
    needs: start_infrastructure
    steps:
      - uses: actions/checkout@v4

      - name: Create results directory
        run: mkdir -p results

      - name: Run smoke tests
        uses: grafana/k6-action@v0.3.0
        with:
          filename: tests/scenarios/smoke-test.js
          flags: "--out json=results/smoke-${{ github.sha }}.json"

      - name: Upload test results
        uses: actions/upload-artifact@v4
        with:
          name: smoke-test-results
          path: results/smoke-${{ github.sha }}.json
          retention-days: 7

  # === LOAD –¢–ï–°–¢–´ ===
  load_test:
    runs-on: ubuntu-latest
    needs: smoke_test
    if: github.ref == 'refs/heads/main'
    steps:
      - uses: actions/checkout@v4

      - name: Setup Git
        run: |
          git config --global --add safe.directory $GITHUB_WORKSPACE
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      - name: Create results directory
        run: mkdir -p results

      - name: Run load tests
        uses: grafana/k6-action@v0.3.0
        with:
          filename: tests/scenarios/load-test.js
          flags: "--out json=results/load-${{ github.sha }}.json"
        timeout-minutes: 20

      - name: Upload test results
        uses: actions/upload-artifact@v4
        with:
          name: load-test-results
          path: results/load-${{ github.sha }}.json
          retention-days: 7

  # === STRESS –¢–ï–°–¢–´ ===
  stress_test:
    runs-on: ubuntu-latest
    needs: load_test
    if: github.ref == 'refs/heads/main'
    steps:
      - uses: actions/checkout@v4

      - name: Setup Git
        run: |
          git config --global --add safe.directory $GITHUB_WORKSPACE
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      - name: Create results directory
        run: mkdir -p results

      - name: Run stress tests
        uses: grafana/k6-action@v0.3.0
        with:
          filename: tests/scenarios/stress-test.js
          flags: "--out json=results/stress-${{ github.sha }}.json"
        timeout-minutes: 15
        continue-on-error: true

      - name: Upload test results
        uses: actions/upload-artifact@v4
        with:
          name: stress-test-results
          path: results/stress-${{ github.sha }}.json
          retention-days: 7

  # === VOLUME –¢–ï–°–¢–´ ===
  volume_test:
    runs-on: ubuntu-latest
    needs: stress_test
    if: github.ref == 'refs/heads/main' && needs.stress_test.result != 'failure'
    steps:
      - uses: actions/checkout@v4

      - name: Setup Git
        run: |
          git config --global --add safe.directory $GITHUB_WORKSPACE
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      - name: Create results directory
        run: mkdir -p results

      - name: Run volume tests
        uses: grafana/k6-action@v0.3.0
        with:
          filename: tests/scenarios/volume-test.js
          flags: "--out json=results/volume-${{ github.sha }}.json"
        timeout-minutes: 40
        continue-on-error: true

      - name: Upload test results
        uses: actions/upload-artifact@v4
        with:
          name: volume-test-results
          path: results/volume-${{ github.sha }}.json
          retention-days: 7

  # === SECURITY –¢–ï–°–¢–´ ===
  security_test:
    runs-on: ubuntu-latest
    needs: start_infrastructure
    if: github.ref == 'refs/heads/main'
    steps:
      - uses: actions/checkout@v4

      - name: Create results directory
        run: mkdir -p results

      - name: Run security tests
        uses: grafana/k6-action@v0.3.0
        with:
          filename: tests/scenarios/security-load-test.js
          flags: "--out json=results/security-${{ github.sha }}.json"

      - name: Upload test results
        uses: actions/upload-artifact@v4
        with:
          name: security-test-results
          path: results/security-${{ github.sha }}.json
          retention-days: 7

  # === ADAPTIVE –¢–ï–°–¢–´ ===
  adaptive_test:
    runs-on: ubuntu-latest
    needs: start_infrastructure
    if: github.ref == 'refs/heads/main'
    steps:
      - uses: actions/checkout@v4

      - name: Create results directory
        run: mkdir -p results

      - name: Run adaptive tests
        uses: grafana/k6-action@v0.3.0
        with:
          filename: tests/scenarios/adaptive-load-test.js
          flags: "--out json=results/adaptive-${{ github.sha }}.json"

      - name: Upload test results
        uses: actions/upload-artifact@v4
        with:
          name: adaptive-test-results
          path: results/adaptive-${{ github.sha }}.json
          retention-days: 7

  # === –û–°–¢–ê–ù–û–í–ö–ê –ò–ù–§–†–ê–°–¢–†–£–ö–¢–£–†–´ ===
  stop_infrastructure:
    runs-on: ubuntu-latest
    needs: [smoke_test, load_test, stress_test, volume_test, security_test, adaptive_test]
    if: always()
    steps:
      - uses: actions/checkout@v4

      - name: Stop infrastructure
        run: docker compose down

  # === –ì–ï–ù–ï–†–ê–¶–ò–Ø –û–¢–ß–ï–¢–û–í ===
  generate_report:
    runs-on: ubuntu-latest
    needs: [smoke_test, load_test, stress_test, volume_test, security_test, adaptive_test]
    if: always() && github.ref == 'refs/heads/main'
    steps:
      - name: Authenticate GitHub CLI
        run: echo "GH_TOKEN=${{ github.token }}" >> $GITHUB_ENV

      - uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.9"

      - name: Install dependencies
        run: |
          pip install pandas matplotlib plotly

      - name: Download all test results
        uses: actions/download-artifact@v4
        with:
          pattern: "*test-results"
          path: results/
          merge-multiple: true

      - name: List downloaded files
        run: |
          echo "=== Downloaded files in results/ ==="
          ls -la results/
          echo "=== All JSON files ==="
          find results/ -name "*.json" -type f | head -20 || echo "No JSON files found"
          echo "=== Directory structure ==="
          find results/ -type f | head -20 || echo "No files found"

      - name: Check downloaded artifacts
        run: |
          echo "Checking downloaded artifacts..."
          ls -la results/
          find results/ -name "*.json" | head -20
          du -sh results/* 2>/dev/null || echo "No artifacts found"

      - name: Generate HTML reports
        run: |
          mkdir -p results
          find results/ -name "*.json" -exec cp {} results/ \; 2>/dev/null || true

          json_files=$(find results/ -maxdepth 1 -name "*.json" | wc -l)
          echo "Found $json_files JSON files in results directory"

          if [ "$json_files" -gt 0 ]; then
            echo "Found test results, generating HTML reports..."

            # Copy the generate-html-report.py script to the workspace
            cp scripts/generate-html-report.py results/

            # Generate comprehensive HTML report
            cd results && python generate-html-report.py .

            echo "=== Generated HTML files ==="
            find . -name "*.html" | head -10

          else
            echo "No test results found"
          fi

      - name: Upload reports
        uses: actions/upload-artifact@v4
        with:
          name: test-reports
          path: results/
          retention-days: 30

      - name: Upload HTML report separately
        uses: actions/upload-artifact@v4
        with:
          name: html-report
          path: results/k6-load-test-report.html
          retention-days: 30

  # === –£–í–ï–î–û–ú–õ–ï–ù–ò–ï (–ú–ò–ù–ò –û–¢–ß–Å–¢) –í TELEGRAM ===
  notify_telegram:
    runs-on: ubuntu-latest
    needs: [ generate_report ]
    if: always() && github.ref == 'refs/heads/main'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y jq
          pip install matplotlib

      - name: Download all test results
        uses: actions/download-artifact@v4
        with:
          pattern: '*test-results'
          path: results/
          merge-multiple: true

      - name: Generate Telegram report
        id: generate_report
        run: |
          OUTPUT=$(python scripts/generate_telegram_report.py results/)
          REPORT_MESSAGE=$(echo "$OUTPUT" | awk '/^üìä K6 Load Test Report/,/CHART_FILE=/ {if (!/CHART_FILE=/) print}')
          CHART_FILE=$(echo "$OUTPUT" | grep "CHART_FILE=" | cut -d'=' -f2 | tr -d ' ')
          echo "REPORT_MESSAGE<<EOF" >> $GITHUB_ENV
          echo "$REPORT_MESSAGE" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV
          echo "CHART_FILE=$CHART_FILE" >> $GITHUB_ENV
          echo "Report message:"
          echo "$REPORT_MESSAGE"
          echo "Chart file path: $CHART_FILE"
          ls -la "$CHART_FILE"

      - name: Verify chart file exists
        run: |
          if [ ! -f "${{ env.CHART_FILE }}" ]; then
            echo "‚ùå Error: Chart file not found at ${{ env.CHART_FILE }}"
            exit 1
          else
            echo "‚úÖ Chart file found: ${{ env.CHART_FILE }}"
          fi

      - name: Send Telegram notification
        if: always()
        uses: appleboy/telegram-action@master
        with:
          to: ${{ secrets.TELEGRAM_CHAT_ID }}
          token: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          message: |
            ${{ env.REPORT_MESSAGE }}
          diagram_image: ${{ env.CHART_FILE }}

  # === –£–í–ï–î–û–ú–õ–ï–ù–ò–Ø SLACK ===
  notify_slack:
    runs-on: ubuntu-latest
    needs: [smoke_test, load_test, stress_test, volume_test, security_test, adaptive_test, generate_report]
    if: always() && github.ref == 'refs/heads/main'
    steps:
      - name: Send Slack notification
        uses: 8398a7/action-slack@v3
        with:
          status: ${{ job.status }}
          text: |
            ${{ job.status == 'success' && 'Yepp)) Load tests passed successfully' || 'Fuck... Load tests failed' }}
            Repository: ${{ github.repository }}
            Branch: ${{ github.ref }}
            Commit: ${{ github.sha }}
            Run: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        if: env.SLACK_WEBHOOK_URL != ''

  # === –û–ß–ò–°–¢–ö–ê –°–¢–ê–†–´–• –ê–†–¢–ï–§–ê–ö–¢–û–í ===
  cleanup:
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    steps:
      - name: Clean up old artifacts
        run: |
          echo "Cleaning up old artifacts..."
          # GitHub Actions automatically cleans up old artifacts
          echo "Cleanup completed"