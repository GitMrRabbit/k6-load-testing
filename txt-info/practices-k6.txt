# ПРАКТИКИ НАГРУЗОЧНОГО ТЕСТИРОВАНИЯ С K6

## 1. ОРГАНИЗАЦИЯ ПРОЕКТА

### 1.1 Структура директорий
```
/k6-load-testing/
├── tests/
│   ├── scenarios/    # Основные сценарии тестов
│   ├── libs/         # Вспомогательные функции и метрики
│   ├── data/         # Тестовые данные и конфигурация
│   └── utils/        # Утилиты для обработки результатов
├── config/           # Конфигурация сред (dev/staging/prod)
├── scripts/          # Скрипты для CI/CD и отчетов
├── results/          # Результаты тестов (не коммитить)
├── docs/             # Документация
└── docker/           # Docker файлы и конфигурация
```

### 1.2 Принципы организации кода
- Модульность: Каждый тест в отдельном файле
- Переиспользование: Общие функции в `libs/`
- Конфигурация: Настройки в `config/`
- Документация: README и комменты

## 2. НАПИСАНИЕ ТЕСТОВ

### 2.1 Структура тестового файла
```javascript
// Импорты
import { check, sleep } from 'k6';
import http from 'k6/http';
import { makeGetRequest } from '../libs/utils.js';

// Конфигурация теста
export const options = {
    stages: [...],
    thresholds: {...}
};

// Настройка (опционально)
export function setup() {
    // Подготовка данных, аутентификация
    return { token: '...' };
}

// Основная функция теста
export default function(data) {
    // Логика теста
    const response = makeGetRequest('/api/data');
    check(response, { 'status is 200': (r) => r.status === 200 });
    sleep(1);
}

// Очистка (опционально)
export function teardown(data) {
    // Очистка данных
}
```

### 2.2 Именование и организация
- Файлы: `kebab-case` (load-test.js, stress-test.js)
- Функции: `camelCase` (makeGetRequest, validateResponse)
- Переменные: `camelCase` (responseTime, userData)
- Константы: `UPPER_SNAKE_CASE` (BASE_URL, TIMEOUT)

## 3. КОНФИГУРАЦИЯ И ПАРАМЕТРИЗАЦИЯ

### 3.1 Использование переменных окружения
```javascript
// config.js
export const ENV = {
    BASE_URL: __ENV.BASE_URL || 'http://localhost:3215',
    VUS: parseInt(__ENV.VUS) || 10,
    DURATION: __ENV.DURATION || '1m'
};

// Запуск с переменными
k6 run -e BASE_URL=https://api.prod.com -e VUS=50 script.js
```

### 3.2 Конфигурационные файлы для сред
```javascript
// config/production.js
export const config = {
    baseUrl: 'https://api.production.com',
    credentials: {
        username: __ENV.PROD_USERNAME,
        password: __ENV.PROD_PASSWORD
    },
    thresholds: {
        http_req_duration: ['p(95)<1000'],
        http_req_failed: ['rate<0.01']
    }
};
```

### 3.3 Параметризация данных
```javascript
// Использование CSV данных
import { SharedArray } from 'k6/data';

const users = new SharedArray('users', function() {
    return papaparse.parse(open('./data/users.csv'), { header: true }).data;
});

export default function() {
    const user = users[Math.floor(Math.random() * users.length)];
    // Использование user данных
}
```

## 4. МЕТРИКИ И МОНИТОРИНГ

### 4.1 Выбор правильных метрик
```javascript
// Базовые метрики (автоматические)
- http_req_duration: Время ответа
- http_req_failed: Ошибки
- vus: Активные пользователи

// Кастомные метрики
import { Trend, Rate, Counter } from 'k6/metrics';

export const responseTime = new Trend('custom_response_time');
export const errorRate = new Rate('custom_error_rate');
export const businessTransactions = Counter('business_txns');
```

### 4.2 Thresholds (пороги)
```javascript
export const options = {
    thresholds: {
        // Технические метрики
        'http_req_duration': ['p(95)<1000', 'p(99)<2000'],
        'http_req_failed': ['rate<0.05'],

        // Бизнес метрики
        'custom_response_time': ['p(95)<500'],
        'business_txns': ['count>1000'],

        // Групповые метрики
        'http_req_duration{endpoint:api}': ['p(95)<800']
    }
};
```

### 4.3 Группировка и тегирование
```javascript
import { group } from 'k6';

export default function() {
    group('Authentication', () => {
        // Тесты аутентификации
    });

    group('API Tests', () => {
        // API тесты
    });
}

// Теги для метрик
responseTime.add(duration, { endpoint: 'users', method: 'GET' });
```

## 5. РЕАЛИСТИЧНОЕ МОДЕЛИРОВАНИЕ

### 5.1 Имитация пользовательского поведения
```javascript
// Случайные задержки (think time)
export default function() {
    const response = http.get('/api/data');

    // Имитация чтения/размышления пользователя
    const thinkTime = Math.random() * 3 + 1; // 1-4 секунды
    sleep(thinkTime);
}
```

### 5.2 Разные паттерны нагрузки
```javascript
// Реалистичные сценарии
const scenarios = {
    // Быстрые просмотры (70%)
    quickBrowse: () => {
        http.get('/products');
        sleep(0.5);
    },

    // Детальный просмотр (20%)
    detailedView: () => {
        http.get('/products/123');
        http.get('/products/123/reviews');
        sleep(2);
    },

    // Покупка (10%)
    purchase: () => {
        // Полный сценарий покупки
        sleep(5);
    }
};
```

### 5.3 Географическое распределение
```javascript
// Разные регионы
export const options = {
    scenarios: {
        'us-east': {
            executor: 'constant-vus',
            vus: 10,
            env: { REGION: 'us-east' }
        },
        'eu-west': {
            executor: 'constant-vus',
            vus: 8,
            env: { REGION: 'eu-west' }
        }
    }
};
```

## 6. ОБРАБОТКА ОШИБОК И ВАЛИДАЦИЯ

### 6.1 Корректная обработка ошибок
```javascript
export default function() {
    try {
        const response = http.get('/api/data');

        // проверяем статус
        if (response.status !== 200) {
            console.error(`API error: ${response.status} ${response.body}`);
            // Не выбрасываем исключение, продолжаем тест
        }

        // Валидация данных
        const data = JSON.parse(response.body);
        check(data, {
            'has required fields': (d) => d.id && d.name,
            'data is valid': (d) => validateData(d)
        });

    } catch (error) {
        console.error(`Request failed: ${error.message}`);
        // Логируем, но не крашим тест
    }
}
```

### 6.2 Graceful degradation
```javascript
// Тесты с fallback сценариями
export default function() {
    let response = http.get('/api/preferred-endpoint');

    if (response.status !== 200) {
        // Fallback к альтернативному эндпоинту
        response = http.get('/api/fallback-endpoint');
    }

    check(response, {
        'service available': (r) => r.status === 200
    });
}
```

## 7. ПРОИЗВОДИТЕЛЬНОСТЬ ТЕСТОВ

### 7.1 Оптимизация k6 скриптов
```javascript
// Лучше избегать в default function
export default function() {
    // НЕ ОЧЕНЬ: Создание данных в каждой итерации
    const payload = generateLargePayload();

    // THE_BESST: Переиспользование данных
    const payload = __ENV.PRE_GENERATED_PAYLOAD;
}

// Использование SharedArray для больших данных
const testData = new SharedArray('data', () => {
    return JSON.parse(open('./data/large-dataset.json'));
});
```

### 7.2 Управление памятью
```javascript
// Очистка больших объектов
export default function() {
    const largeData = http.get('/large-dataset').json();

    // Обработка данных
    processData(largeData);

    // Очистка ссылки для GC
    largeData = null;
}
```

### 7.3 Параллельные запросы
```javascript
// Batch запросы для имитации параллелизма
const responses = http.batch([
    ['GET', '/api/users'],
    ['GET', '/api/products'],
    ['POST', '/api/cart', null, { 'Content-Type': 'application/json' }]
]);
```

## 8. CI/CD ИНТЕГРАЦИЯ

### 8.1 Автоматизация запуска
```yaml
# .gitlab-ci.yml
stages:
  - test
  - performance

load_test:
  stage: performance
  script:
    - docker-compose up -d
    - docker exec k6-dashboard k6 run --out json=results.json tests/scenarios/load-test.js
  artifacts:
    paths:
      - results.json
    reports:
      performance: results.json
  only:
    - merge_requests
```

### 8.2 Сравнение результатов
```javascript
// Скрипт сравнения
const baseline = JSON.parse(open('./baseline-results.json'));
const current = JSON.parse(open('./current-results.json'));

check(current, {
    'response time not degraded': (c) => c.metrics.http_req_duration.values.avg <= baseline.metrics.http_req_duration.values.avg * 1.1,
    'error rate acceptable': (c) => c.metrics.http_req_failed.values.rate <= 0.05
});
```

ИМХО - не руководство к действию - скорее для информации
### 8.3 Регулярные тесты
- Smoke tests: После каждого коммита
- Load tests: Еженедельно или перед релизом
- Stress tests: Перед major релизами (опционально)
- Performance regression: При изменениях в коде

## 9. ОТЧЕТНОСТЬ И АНАЛИТИКА

### 9.1 Форматы отчетов
```bash
# JSON для автоматизации
k6 run --out json=results.json script.js

# CSV для анализа в Excel
k6 run --out csv=results.csv script.js

# InfluxDB для Grafana
k6 run --out influxdb=http://localhost:8086/k6 script.js
```

С этим пока проблемки (но когда нибудь....)
### 9.2 Автоматическая генерация отчетов
```javascript
// handleSummary для кастомных отчетов
export function handleSummary(data) {
    return {
        'stdout': textSummary(data, { indent: ' ', enableColors: true }),
        'results.json': JSON.stringify(data),
        'report.html': htmlReport(data),
    };
}
```

### 9.3 Ключевые метрики для отчетов
- Performance: p95, p99 response times
- Reliability: Error rates, uptime
- Scalability: Throughput vs resources
- Business: Conversion rates, user satisfaction

## 10. БЕЗОПАСНОСТЬ И СЕКРЕТЫ

### 10.1 Хранение секретов
```bash
# Переменные окружения, не в коде
k6 run -e API_KEY=$API_KEY -e DB_PASSWORD=$DB_PASSWORD script.js

# .env файлы
API_KEY=secret_key_here
DB_PASSWORD=secret_password
```

### 10.2 Аутентификация в тестах
```javascript
// JWT токены
const token = getAuthToken();
const headers = { 'Authorization': `Bearer ${token}` };

// API ключи
const headers = { 'X-API-Key': __ENV.API_KEY };

// Cookies
const jar = http.cookieJar();
jar.set('https://testsite.com', 'session_id', 'abc123');
```

### 10.3 Защита от злоупотреблений
- Rate limiting: Соблюдайте лимиты API
- Test data: Используйте тестовые аккаунты
- Cleanup: Удаляйте тестовые данные после тестов

## 11. ОТЛАДКА И ТРОУБЛШУТИНГ

### 11.1 Логирование
```javascript
// Разные уровни логирования
console.log('Info message');      // Всегда выводится
console.debug('Debug info');      // Только в verbose режиме
console.error('Error message');   // Ошибки

// Структурированное логирование
console.log(JSON.stringify({
    timestamp: new Date().toISOString(),
    vus: __VU,
    iteration: __ITER,
    endpoint: '/api/test',
    response_time: response.timings.duration
}));
```

### 11.2 Отладка скриптов
```bash
# Проверка синтаксиса
k6 check script.js

# Запуск с подробным выводом
k6 run --verbose script.js

# Остановка на первой ошибке
k6 run --abort-on-first-error script.js

# Лимит итераций для отладки
k6 run --iterations 10 script.js
```

### 11.3 Обработка таймаутов
```javascript
// Настройка таймаутов
const response = http.get('/api/slow-endpoint', {
    timeout: '10s'  // Таймаут 10 секунд
});

// Проверка таймаутов
check(response, {
    'no timeout': (r) => !r.timings.timed_out
});
```

## 12. СКЕЙЛИНГ

### 12.1 Распределенное тестирование
```bash
# k6 Cloud для больших нагрузок
k6 run --out cloud script.js

# Docker для локального масштабирования
docker-compose up --scale k6=5
```


