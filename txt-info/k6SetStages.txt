# РУКОВОДСТВО ПО НАСТРОЙКЕ НАГРУЗКИ В K6 (STAGES, PACING, СТРАТЕГИИ)

## 1. ОСНОВНЫЕ КОНЦЕПЦИИ НАГРУЗКИ В K6

### 1.1 Virtual Users (VUS) - Виртуальные Пользователи
- Что это: Эмуляция реальных пользователей, каждый VUS выполняет сценарий теста параллельно
- Как работает: Каждый VUS имеет свой собственный контекст выполнения (переменные, куки, соединения)
- Важно: VUS ≠ реальные пользователи, но имитируют их поведение

### 1.2 Stages (Этапы/Ступени) - Основной механизм управления нагрузкой
- Определение: Массив объектов, описывающих временные интервалы с целевыми значениями VUS
- Структура этапа:
  ```javascript
  {
    duration: '5m',    // Продолжительность этапа (время)
    target: 100        // Целевое количество VUS к концу этапа
  }
  ```

### 1.3 Pacing (Темп) - Контроль частоты выполнения итераций
- Что это: Время ожидания между итерациями одного VUS
- Зачем нужно: Предотвращает перегрузку системы, имитирует реальное пользовательское поведение
- Реализация: Использование `sleep()` между итерациями

## 2. СТРАТЕГИИ НАГРУЗКИ И ИХ ПРИМЕНЕНИЕ

### 2.1 Load Testing (Тестирование стабильной нагрузки)
Цель: Проверка производительности под постоянной нагрузкой
Пример из проекта:
```javascript
stages: [
    { duration: '2m', target: 10 },    // Ramp-up: постепенный рост до 10 VUS за 2 мин
    { duration: '5m', target: 10 },    // Стабильная нагрузка: 5 мин с 10 VUS
    { duration: '2m', target: 20 },    // Увеличение: рост до 20 VUS за 2 мин
    { duration: '3m', target: 20 },    // Пиковая нагрузка: 3 мин с 20 VUS
    { duration: '2m', target: 0 },     // Ramp-down: снижение до 0 VUS за 2 мин
]
```

Почему такой порядок:
1. Ramp-up (2m → 10 VUS): Постепенный рост позволяет системе адаптироваться, выявляет проблемы масштабирования
2. Плато (5m @ 10 VUS): Стабильная нагрузка для измерения baseline производительности
3. Второй ramp-up (2m → 20 VUS): Проверка реакции на увеличение нагрузки
4. Второе плато (3m @ 20 VUS): Измерение производительности под повышенной нагрузкой
5. Ramp-down (2m → 0 VUS): Корректное завершение, проверка graceful shutdown

### 2.2 Stress Testing (Тестирование на прочность)
Цель: Нахождение пределов системы, точек отказа
Характеристики:
- Быстрый рост нагрузки
- Экстремальные значения
- Короткие плато для анализа

```javascript
stages: [
    { duration: '1m', target: 10 },    // Быстрый старт
    { duration: '2m', target: 50 },    // Агрессивный рост
    { duration: '3m', target: 100 },   // Высокая нагрузка
    { duration: '2m', target: 200 },   // Экстремальная нагрузка
    { duration: '1m', target: 0 },     // Резкий спад
]
```

### 2.3 Spike Testing (Тестирование пиковых нагрузок)
Цель: Имитация внезапных всплесков трафика
Особенности:
- Резкие изменения нагрузки
- Короткие интервалы
- Фокус на восстановление после пика

```javascript
stages: [
    { duration: '30s', target: 50 },   // Быстрый рост
    { duration: '1m', target: 50 },    // Поддержание
    { duration: '10s', target: 200 },  // ВНЕЗАПНЫЙ СПАЙК!
    { duration: '1m', target: 200 },   // Пиковая нагрузка
    { duration: '30s', target: 50 },   // Быстрое снижение
    { duration: '30s', target: 0 }     // Завершение
]
```

### 2.4 Soak Testing (Тестирование продолжительной нагрузки)
Цель: Выявление проблем с течением времени (утечки памяти, degradation)
Особенности:
- Длительное время выполнения (часы/дни)
- Циклические паттерны нагрузки
- Мониторинг трендов

```javascript
stages: [
    { duration: '2h', target: 10 }  // Длительная нагрузка
]
// Внутри теста: циклические паттерны (низкая/средняя/высокая нагрузка)
```

### 2.5 Volume Testing (Тестирование больших объемов данных)
Цель: Проверка работы с большими наборами данных
Особенности:
- Фокус на объемах, не на concurrency
- Разные размеры данных в запросах

```javascript
stages: [
    { duration: '30m', target: 20 }  // Стабильная нагрузка с разными объемами
]
```

### 2.6 Smoke Testing
Цель: Быстрая проверка основных функций
Особенности:
- Минимальная нагрузка
- Короткое время выполнения

```javascript
vus: 1,              // Только 1 VUS
duration: '1m'       // 1 минута
```

## 3. ПОДРОБНЫЙ АНАЛИЗ МЕХАНИЗМА STAGES

### 3.1 Как работает переход между этапами
- Линейная интерполяция: k6 автоматически рассчитывает скорость роста/падения VUS
- Пример: `{ duration: '2m', target: 10 }` → 5 VUS в минуту
- Точность: Переходы происходят плавно, но не мгновенно

### 3.2 Время выхода на ступень (Ramp-up time)
- Расчет: `target / duration` = скорость роста VUS
- Пример: 20 VUS за 2 минуты = 10 VUS/минуту
- Рекомендации:
  - Ramp-up: 10-25% от общего времени теста
  - Не делать ramp-up короче 1 минуты
  - Для критичных систем: постепеннее рост

### 3.3 Стратегии расположения этапов

#### 3.3.1 Классическая пирамида (для load testing)
```
Ramp-up → Плато → Ramp-up → Плато → Ramp-down
   ↑         ↑         ↑         ↑         ↑
  2m       5m        2m        3m        2m
  →10     @10        →20       @20        →0
```

#### 3.3.2 Ступенчатый рост (stepped load)
```
Каждый этап увеличивает нагрузку на фиксированную величину
Полезно для: определения точных порогов производительности
```

#### 3.3.3 Циклический паттерн (для soak testing)
```
Повторяющиеся циклы: низкая → средняя → высокая → низкая
Полезно для: выявления degradation со временем
```

## 4. PACING - КОНТРОЛЬ ТЕМПА ВЫПОЛНЕНИЯ

### 4.1 Основные подходы

#### 4.1.1 Фиксированный pacing
```javascript
export default function() {
    // Выполнение запросов
    makeGetRequest(url, 'test');

    // Фиксированная пауза
    sleep(1); // 1 секунда между итерациями
}
```

#### 4.1.2 Случайный pacing (реалистичный)
```javascript
export default function() {
    // Имитация человеческого поведения
    const thinkTime = Math.random() * 3 + 1; // 1-4 секунды
    sleep(thinkTime);
}
```

#### 4.1.3 Адаптивный pacing
```javascript
export default function() {
    // Pacing на основе нагрузки
    const currentVUs = __VU; // Текущий номер VUS
    const pacing = 1 + (currentVUs * 0.1); // Увеличивается с нагрузкой
    sleep(pacing);
}
```

### 4.2 Почему важен pacing
- Без pacing: Система может получить тысячи RPS, что нереалистично
- С pacing: Имитация реального поведения пользователей
- Результат: Более точные результаты тестирования

## 5. ПРАКТИЧЕСКИЕ РЕКОМЕНДАЦИИ

### 5.1 Выбор стратегии по типу приложения
- API сервисы: Быстрый ramp-up, короткие плато
- Web приложения: Длинный ramp-up, имитация пользовательских паттернов
- Базы данных: Постепенный рост, фокус на стабильности

### 5.2 Оптимизация для облачных сервисов
```javascript
ext: {
    loadimpact: {
        projectID: 12345,
        name: 'Test Name'
    }
}
```

### 5.3 Мониторинг и корректировка
- Метрики для отслеживания: response time, error rate, throughput
- Корректировка: На основе результатов предыдущих тестов
- Итеративный подход: Тест → Анализ → Корректировка → Повтор

## 6. ЧАСТЫЕ ОШИБКИ И ИХ ИЗБЕЖАНИЕ

### 6.1 Слишком быстрый ramp-up
Проблема: Система не успевает адаптироваться
Решение: Делать ramp-up не короче 1-2 минут

### 6.2 Отсутствие плато
Проблема: Нет времени для стабильных измерений
Решение: Добавлять плато продолжительностью 3-5 минут

### 6.3 Игнорирование cooldown
Проблема: Резкое падение нагрузки может скрыть проблемы
Решение: Всегда добавлять ramp-down этап

### 6.4 Неправильный pacing
Проблема: Нереалистичные результаты
Решение: Использовать случайный pacing 1-5 секунд

## 7. ПРИМЕРЫ ИЗ ПРОЕКТА

### 7.1 Load Test (классический подход)
```javascript
stages: [
    { duration: '2m', target: 10 },    // Ramp-up
    { duration: '5m', target: 10 },    // Стабильная нагрузка
    { duration: '2m', target: 20 },    // Увеличение
    { duration: '3m', target: 20 },    // Пиковая нагрузка
    { duration: '2m', target: 0 },     // Ramp-down
]
```

### 7.2 Stress Test (агрессивный рост)
```javascript
stages: [
    { duration: '1m', target: 10 },
    { duration: '2m', target: 50 },
    { duration: '3m', target: 100 },
    { duration: '2m', target: 200 },
    { duration: '1m', target: 0 }
]
```

### 7.3 Spike Test (резкие изменения)
```javascript
stages: [
    { duration: '30s', target: 50 },
    { duration: '1m', target: 50 },
    { duration: '10s', target: 200 },  // !
    { duration: '1m', target: 200 },
    { duration: '30s', target: 50 },
    { duration: '30s', target: 0 }
]
```

## 8. ДОПОЛНИТЕЛЬНЫЕ СОВЕТЫ

### 8.1 Комбинация с другими инструментами
- k6 + Prometheus: Для детального мониторинга
- k6 + Grafana: Для визуализации результатов
- k6 + InfluxDB: Для хранения метрик

---
