# Описание проекта k6 Load Testing Suite

## Общая информация
Это комплексная система нагрузочного тестирования на базе k6 с полной интеграцией мониторинга, отчетности и CI/CD. Проект предназначен для проведения различных типов нагрузочных тестов веб-приложений и API с автоматическим сбором метрик и генерацией отчетов.

## Архитектура проекта

### Основные компоненты
```
k6-load-testing/
├── config/                 # Конфигурационные файлы
├── tests/                  # Тестовые сценарии и библиотеки
├── scripts/                # Скрипты автоматизации
├── docker/                 # Docker конфигурации
├── grafana/               # Дашборды Grafana
├── prometheus/            # Конфигурация Prometheus
├── results/               # Результаты тестов
└── docker-compose.yml     # Инфраструктура
```

### Технологический стек
- k6: Основной инструмент нагрузочного тестирования
- Node.js: Управление проектом и конфигурациями
- Python: Генерация отчетов и анализ данных
- Docker: Контейнеризация инфраструктуры
- Prometheus: Сбор системных метрик
- Grafana: Визуализация метрик и дашборды
- InfluxDB: Хранение метрик k6
- Redis: Кеширование и управление состоянием

## Структура конфигураций

### config/default.js
Базовая конфигурация проекта:
- baseUrl: Основной URL тестируемого приложения
- testDuration: Продолжительность тестов
- vus: Количество виртуальных пользователей
- monitoring: Настройки Prometheus, Grafana, InfluxDB
- thresholds: Пороги производительности

### config/dev.js, staging.js, production.js
Специфические настройки для разных сред:
- dev: Разработка с включенным логированием
- staging: Стадия тестирования с chaos testing
- production: Продакшн с строгими thresholds

### config/validation.js
Валидация конфигурационных файлов:
- Проверка корректности URL
- Валидация портов (1-65535)
- Проверка VUS (1-1000)
- Валидация failure rate (0-1)

## Тестовые библиотеки (tests/libs/)

### utils.js
Вспомогательные функции и метрики:
- makeGetRequest(), makePostRequest(): HTTP запросы
- Метрики: requestDuration, errorCount, successRate, throughputRate
- check() функции для валидации ответов

### auth.js
Система аутентификации:
- login(), logout(): Управление сессиями
- getAuthToken(): Получение токенов
- Поддержка Basic Auth и API keys

### data-generator.js
Генератор тестовых данных:
- generateUser(): Создание пользователей
- generatePost(): Генерация постов
- generateComment(): Создание комментариев
- generateTodo(): Задачи пользователей

### resilience.js
Механизмы отказоустойчивости:
- CircuitBreaker: Предохранитель для защиты от каскадных сбоев
- RetryStrategy: Стратегия повторных попыток
- FallbackStrategy: Резервные стратегии

### state-manager.js
Управление состоянием тестов:
- set(), get(): Работа с глобальным состоянием
- acquireLock(), releaseLock(): Синхронизация
- requestCache: Кеширование запросов

### feature-flags.js
Система флагов функциональности:
- isEnabled(): Проверка включения фич
- getChaosConfig(): Настройки chaos testing

### performance-budget.js
Бюджеты производительности:
- checkBudget(): Проверка соответствия метрик
- generateBudgetReport(): Отчеты по бюджетам

## Тестовые сценарии (tests/scenarios/)

### smoke-test.js
Дымовые тесты:
- Быстрая проверка базовой функциональности
- Минимальная нагрузка (1 VUS)
- Проверка основных эндпоинтов

### load-test.js
Нагрузочные тесты:
- Стабильная нагрузка с постепенным увеличением
- Проверка производительности под нормальной нагрузкой
- 70% чтение, 30% запись

### stress-test.js
Стресс-тесты:
- Нагрузка до 200 VUS
- Проверка пределов системы
- 60% чтение, 20% запись, 20% сложные запросы

### soak-test.js
Тесты на выносливость:
- Длительная нагрузка (2 часа)
- Проверка стабильности системы
- Различные паттерны нагрузки

### volume-test.js
Тесты объема данных:
- Работа с большими объемами данных
- Проверка обработки больших payload
- Различные размеры данных (small/medium/large)

### chaos-engineering-test.js
Chaos engineering:
- Инъекция задержек и ошибок
- Тестирование отказоустойчивости
- CircuitBreaker и fallback стратегии

### adaptive-load-test.js
Адаптивные тесты:
- Динамическое изменение нагрузки
- Анализ метрик в реальном времени
- Автоматическая адаптация

### canary-test.js
Канареечные тесты:
- Сравнение производительности версий
- Постепенное перенаправление трафика
- A/B тестирование

### security-load-test.js
Безопасность под нагрузкой:
- SQL injection тесты
- XSS атаки
- Детекция уязвимостей

### e2e-user-journey.js
End-to-end пользовательские сценарии:
- Полный путь пользователя
- Регистрация → Посты → Комментарии → Задачи
- Метрики journey success

### data-driven-test.js
Тесты на основе данных:
- Загрузка данных из CSV
- Параметризация тестов
- Валидация данных

### chain-test.js
Цепочечные тесты:
- Зависимые операции
- Проверка целостности данных
- Параллельные запросы

## Система мониторинга

### Prometheus (prometheus/prometheus.yml)
- Сбор системных метрик (CPU, память, нагрузка)
- Сбор метрик из InfluxDB
- Интервал сбора: 15 секунд

### Grafana
- Дашборды для визуализации метрик
- k6-dashboard.json: Основной дашборд с графиками
- Метрики: request rate, response time, error rate, VUS

### InfluxDB
- Хранение метрик k6
- База данных: k6
- Интеграция с Grafana

## Скрипты автоматизации

### scripts/generate-report.py
- Генерация сводных JSON отчетов
- Сбор метрик из всех тестов
- Сохранение summary_report.json

### scripts/generate-html-report.py
- Создание HTML отчетов с графиками
- Использование Plotly для визуализации
- Метрики: response time, error rate, throughput

### scripts/compare-results.py
- Сравнение результатов тестов
- Baseline comparison
- Cross-test comparison

### scripts/run-all-tests.ps1
- Автоматизация запуска всех тестов
- Запуск инфраструктуры
- Генерация отчетов

## CI/CD интеграция (.github/workflows/ci.yml)

### Стадии пайплайна:
1. validate: Валидация конфигурации
2. test: Выполнение тестов (smoke, load, stress, volume)
3. report: Генерация отчетов
4. deploy: Развертывание инфраструктуры

### Особенности:
- Артефакты сохраняются на 1 неделю/месяц
- Ручной запуск для тяжелых тестов
- Docker образы для изоляции

## Docker инфраструктура

### docker-compose.yml
Сервисы:
- prometheus: Сбор метрик
- grafana: Визуализация
- influxdb: Хранение метрик k6
- k6-dashboard: Контейнер для запуска тестов
- node-exporter: Системные метрики
- redis: Кеширование

### check-services.ps1
Проверка здоровья сервисов:
- Статус контейнеров
- Доступность сервисов
- Проверка метрик в БД
- Сетевая связность

## Метрики и KPI

### Основные метрики k6:
- http_req_duration: Время ответа (avg, p95, p99)
- http_req_failed: Процент ошибок
- http_reqs: Количество запросов
- vus: Активные виртуальные пользователи

### Пороги производительности:
```javascript
thresholds: {
  http_req_duration: ['p(95)<1000'],
  http_req_failed: ['rate<0.01'],
  http_reqs: ['rate>50']
}
```