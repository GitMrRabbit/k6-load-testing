ДОКУМЕНТАЦИЯ K6: ОСНОВНЫЕ МЕТОДЫ, ФУНКЦИИ И ОСОБЕННОСТИ

Этот файл содержит подробное описание основных методов, функций и особенностей k6,
используемых в проекте load testing. Все примеры основаны на реальном коде проекта.

## 1. ОСНОВНЫЕ МОДУЛИ K6

### HTTP МОДУЛЬ (k6/http)
Основной модуль для выполнения HTTP запросов.

```javascript
import http from 'k6/http';

// Основные методы:
const response = http.get(url);                    // GET запрос
const response = http.post(url, data, params);    // POST запрос
const response = http.put(url, data, params);     // PUT запрос
const response = http.del(url, params);           // DELETE запрос
const responses = http.batch(requests);           // Пакетные запросы
```

### МЕТРИКИ (k6/metrics)
Для сбора и анализа производительности.

```javascript
import { Trend, Counter, Rate, Gauge } from 'k6/metrics';

// Типы метрик:
const responseTime = new Trend('response_time');     // Тренд (время ответа)
const errorCount = new Counter('errors');            // Счетчик (количество ошибок)
const successRate = new Rate('success_rate');        // Процент (успешных запросов)
const activeUsers = new Gauge('active_users');       // Датчик (активные пользователи)
```

### CHECK ФУНКЦИЯ (k6)
Для валидации ответов и условий.

```javascript
import { check } from 'k6';

// Проверка условий:
const isSuccess = check(response, {
    'status is 200': (r) => r.status === 200,
    'response time < 2s': (r) => r.timings.duration < 2000,
    'has data': (r) => r.body.length > 0
});

// Возвращает true если все проверки пройдены
```

## 2. SHARED ARRAY (k6/data)
Для загрузки данных один раз и совместного использования между VU.

```javascript
import { SharedArray } from 'k6/data';

// Загрузка CSV данных:
const usersData = new SharedArray('users', function() {
    return papaparse.parse(open('./data/users.csv'), { header: true }).data;
});

// Загрузка JSON данных:
const configData = new SharedArray('config', function() {
    return JSON.parse(open('./config.json'));
});
```

## 3. ОПЦИИ ТЕСТА (options)

### Основные настройки:
```javascript
export const options = {
    vus: 10,                    // Количество виртуальных пользователей
    duration: '5m',            // Продолжительность теста
    iterations: 100,           // Количество итераций (альтернатива duration)

    // Стадии нагрузки (stages):
    stages: [
        { duration: '1m', target: 10 },   // Разгон до 10 VU за 1 минуту
        { duration: '3m', target: 10 },   // Держать 10 VU 3 минуты
        { duration: '1m', target: 0 }     // Снижение до 0 VU за 1 минуту
    ],

    // Пороги (thresholds):
    thresholds: {
        'http_req_duration': ['p(95)<500'],     // 95% запросов < 500ms
        'http_req_failed': ['rate<0.1']         // < 10% ошибок
    }
};
```

## 4. СТРУКТУРА ОТВЕТА (response)

```javascript
const response = http.get('https://api.example.com/users');

// Основные свойства:
response.status          // HTTP статус код (200, 404, 500)
response.body           // Тело ответа (строка)
response.headers        // Заголовки ответа
response.timings        // Время выполнения
response.timings.duration    // Общее время запроса
response.timings.waiting     // Время ожидания ответа сервера
response.timings.receiving   // Время получения данных
```

## 5. РАБОТА С ДАННЫМИ

### JSON парсинг:
```javascript
const data = JSON.parse(response.body);
const userId = data.id;
const users = data.users;
```

### Генерация случайных данных:
```javascript
// Случайное число:
const randomId = Math.floor(Math.random() * 100) + 1;

// Случайная строка:
const randomString = Math.random().toString(36).substring(7);

// Случайный элемент массива:
const randomUser = usersData[Math.floor(Math.random() * usersData.length)];
```

## 6. ГРУППИРОВКА И ОРГАНИЗАЦИЯ (group)

```javascript
import { group } from 'k6';

export default function() {
    group('Регистрация пользователя', function() {
        // Шаги регистрации
        const registerResponse = http.post('/register', payload);
        check(registerResponse, { 'registered': (r) => r.status === 201 });
    });

    group('Авторизация', function() {
        // Шаги авторизации
        const loginResponse = http.post('/login', credentials);
        check(loginResponse, { 'logged in': (r) => r.status === 200 });
    });
}
```

## 7. SLEEP И ЗАДЕРЖКИ

```javascript
import { sleep } from 'k6';

export default function() {
    // Выполнить запрос
    http.get('/api/data');

    // Пауза между итерациями (случайная 1-3 секунды)
    sleep(Math.random() * 2 + 1);
}
```

## 8. ПЕРЕМЕННЫЕ ОКРУЖЕНИЯ (__ENV)

```javascript
// Доступ к переменным окружения:
const baseUrl = __ENV.BASE_URL || 'https://api.example.com';
const vus = parseInt(__ENV.VUS) || 10;
const testDuration = __ENV.TEST_DURATION || '5m';

// Запуск с переменными:
k6 run -e BASE_URL=https://staging.api.com -e VUS=20 script.js
```

## 9. SETUP И TEARDOWN ФУНКЦИИ

```javascript
// Выполняется один раз перед тестом
export function setup() {
    console.log('Настройка теста...');

    // Подготовка данных
    const authToken = loginAndGetToken();

    // Возврат данных для использования в основном тесте
    return { authToken };
}

// Основная функция теста
export default function(data) {
    // data содержит результат setup()
    const token = data.authToken;

    // Выполнение тестовых запросов
}

// Выполняется один раз после теста
export function teardown(data) {
    console.log('Завершение теста...');

    // Очистка данных
    cleanupTestData(data.authToken);
}
```

## 10. ОБРАБОТКА ОШИБОК

```javascript
try {
    const response = http.get('/api/data');
    if (response.status !== 200) {
        console.error(`Ошибка запроса: ${response.status}`);
        // Обработка ошибки
    }
} catch (error) {
    console.error(`Сетевая ошибка: ${error.message}`);
    // Обработка исключения
}
```

## 11. ТИПЫ ТЕСТИРОВАНИЯ

### Smoke Test (Дымовое тестирование):
```javascript
export const options = {
    vus: 1,           // Минимальная нагрузка
    duration: '10s',  // Короткая продолжительность
    thresholds: {
        'http_req_failed': ['rate<0.1']  // Минимум ошибок
    }
};
```

### Load Test (Тест нагрузки):
```javascript
export const options = {
    stages: [
        { duration: '2m', target: 100 },   // Постепенный рост нагрузки
        { duration: '5m', target: 100 },   // Стабильная нагрузка
        { duration: '2m', target: 200 },   // Пиковая нагрузка
        { duration: '2m', target: 0 }      // Снижение нагрузки
    ]
};
```

### Stress Test (Стресс-тест):
```javascript
export const options = {
    stages: [
        { duration: '1m', target: 100 },
        { duration: '2m', target: 200 },
        { duration: '2m', target: 300 },   // Превышение нормальной нагрузки
        { duration: '2m', target: 400 },   // Критическая нагрузка
        { duration: '1m', target: 0 }
    ]
};
```

### Spike Test (Тест пиковой нагрузки):
```javascript
export const options = {
    stages: [
        { duration: '10s', target: 10 },   // Нормальная нагрузка
        { duration: '10s', target: 1000 }, // Резкий скачок (спайк)
        { duration: '10s', target: 10 }    // Возврат к нормальной
    ]
};
```

## 12. ЗАПУСК ТЕСТОВ

### Базовый запуск:
```bash
k6 run script.js
```

### С опциями:
```bash
k6 run --vus 50 --duration 10m script.js
```

### С переменными окружения:
```bash
k6 run -e BASE_URL=https://api.com -e VUS=20 script.js
```

### С выводом в файл:
```bash
k6 run --out json=results.json script.js
```

### С Cloud выполнением:
```bash
k6 cloud script.js
```

## 13. АНАЛИЗ РЕЗУЛЬТАТОВ

### Основные метрики:
- **http_req_duration**: Время выполнения запроса
- **http_req_failed**: Процент неудачных запросов
- **http_req_waiting**: Время ожидания ответа сервера
- **iteration_duration**: Время одной итерации
- **vus**: Количество активных виртуальных пользователей

### Пороги (thresholds):
```javascript
thresholds: {
    'http_req_duration': ['p(95)<500'],    // 95% запросов < 500ms
    'http_req_duration': ['avg<300'],      // Среднее время < 300ms
    'http_req_failed': ['rate<0.05']       // Ошибок < 5%
}
```

## 14. ЛУЧШИЕ ПРАКТИКИ

### 1. Используйте check() для валидации:
```javascript
check(response, {
    'status ok': (r) => r.status === 200,
    'fast response': (r) => r.timings.duration < 1000
});
```

### 2. Группируйте связанные запросы:
```javascript
group('User Registration', () => {
    // Все шаги регистрации здесь
});
```

### 3. Используйте SharedArray для больших данных:
```javascript
const testData = new SharedArray('data', () => {
    return JSON.parse(open('./test-data.json'));
});
```

### 4. Настраивайте пороги для каждого эндпоинта:
```javascript
thresholds: {
    'http_req_duration{endpoint:api}': ['p(95)<300'],
    'http_req_duration{endpoint:auth}': ['p(95)<200']
}
```

### 5. Используйте setup/teardown для подготовки:
```javascript
export function setup() {
    // Подготовка тестовых данных
    return { token: getAuthToken() };
}
```

Эта документация охватывает все основные аспекты работы с k6, используемые в проекте.
